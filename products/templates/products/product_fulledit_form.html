{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{# from theme("security/_macros.html") import render_field_with_errors4, render_field, render_field_with_errors4_help #}
{# from theme("prefixes/range_macros.html") import render_range_breadcrumb, render_gtin, render_gtin13, render_package_level #}
{% block title %}GS1 Activate: Edit product{% endblock %}
{% block breadcrumb %}
    <ol class="breadcrumb" style="display:inline-block">
        <li><a href="{% url 'users:profile' %}">{% trans 'Home' %}</a></li>
        <li>{% trans 'Edit product' %}</li>
    </ol>
    <div class="active_range pull-right">
        {% include 'prefixes/range_macros.html' with func='render_range_breadcrumb' prefix=prefix only %}
        <a href="{% url 'prefixes:prefixes_list' %}"> [{% trans 'Change' %}]</a>
    </div>
{% endblock %}
{% block site_content %}
    <div class="site-content">

        <div>
            <h2>
                {% block page_title %}{% trans 'Edit product' %}{% endblock %}
            </h2>

            <div style="position: absolute; right: 10px; top: 10px; text-align: right;">
                <a href="{{ request.user.profile.member_organisation.gs1_help_url_3 }}">
                    <b>{{ request.user.profile.member_organisation.gs1_help_label_3 }}</b>
                    <img src="{% static 'site/img/training_button_2.png' %}" alt="{% trans 'Help' %}"
                         style="width: auto;height: 30px;">
                </a>
            </div>
        </div>

        {% block page_content %}
            <div class="site-content-padder">

                <form method="post" enctype="multipart/form-data" id="detailsform">
                    {% csrf_token %}
                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}
                    <div class="tabbable">
                        <ul class="nav nav-tabs" role="tablist" style="padding-left: 0" id="product-nav">
                            <li class="active"><a href="#details" role="tab" data-toggle="tab">{% trans 'Basic' %}</a>
                            </li>
                            <li><a href="#measurements" role="tab" data-toggle="tab">{% trans 'Measurements' %}</a></li>
                            {% if advanced_tab %}
                                <li><a href="#gepir" role="tab" data-toggle="tab">{% trans 'Advanced' %}</a></li>
                            {% endif %}
                            {% if pkg_level >= 4 and pkg_level <= 70 %}
                                <li><a href="#picture" role="tab" data-toggle="tab">{% trans 'Picture' %}</a></li>
                            {% endif %}
                            <li><a href="#barcodes" role="tab" data-toggle="tab">{% trans 'Symbols' %}</a></li>
                            <li><a href="#summary" role="tab" data-toggle="tab">{% trans 'Summary' %}</a></li>

                            {% if product_package_level_id == 70 %}
                                <li><a href="#cloud" role="tab" data-toggle="tab">{% trans 'GS1 Cloud' %}</a></li>
                            {% endif %}

                        </ul>
                        <div class="tab-content">


                            <!---------- Tab Basic ------------------------------------------------------------------------------------------------>
                            <div id="details" class="tab-pane active">
                                <fieldset class='fieldset'>
                                    <legend>{% trans 'Product Identification' %}</legend>
                                    <div class="well">
                                        <p>{% blocktrans %}
                                            When giving the barcode number for a product to your printer/graphic
                                            designer/packaging designer for the creation of a barcode symbol,
                                            please ignore the preceding 0 attached to the barcode number
                                            below if the package level is a base unit and inner case. Keep the 0 if
                                            the package level is an outer case or pallet.
                                        {% endblocktrans %}</p>
                                    </div>
                                    <div class='row'>
                                        <div class='col-xs-12'>
                                            <fieldset class='fieldset' style="border-color: #dd0000">

                                                <legend>{% trans 'GTIN' %}</legend>

                                                {% if product_package_level_id != 70 or current_user.enable_leading %}
                                                    <!-- GTIN-14 leading digit picker -->
                                                    <input class="form-control"
                                                           {% if not current_user.enable_leading %}readonly="readonly"{% endif %}
                                                           size="1" maxlength="1" id="gtin0" name="gtin0"
                                                           type="number" min="0" max="9" value="{{ gtin0 }}"
                                                           style="display:inline;width:15%;text-align:right;font-weight:bold;font-size:1.5em;width:5ch;height:3em"/>
                                                    <!-- show 0 for UPC prfixes -->
                                                    {% if prefix.prefix.0 == '0' %}
                                                        <div class="gtin13-class">0</div>
                                                    {% endif %}
                                                {% endif %}

                                                <div id="gtin13" class="gtin13-class">
                                                    {# render_gtin13(gtin13, prefix.prefix|length, kind) #}
                                                    {% include 'prefixes/range_macros.html' with func='render_gtin13' gtin13=gtin13 plength=prefix.prefix|length kind=kind case=False only %}
                                                </div>

                                            </fieldset>
                                            <br/>
                                        </div>
                                    </div>

                                    {% include 'products/_product_details.html' %}

                                    <div class="row">

                                        <div class="col-md-6">

                                            <!-- product options -->
                                            <fieldset class='fieldset' id="options_fs"
                                                      {% if form.errors.optionalFields %}style="color:#b94a48 !important; border: 1px solid #b94a48;"{% endif %}>
                                                <legend
                                                    {% if form.errors.optionalFields %}style="color:#b94a48 !important;"{% endif %}>
                                                    {% trans 'Options' %}<span style="color: red"> * </span><span
                                                    style="font-size: 0.6em;vertical-align: middle;">{% trans '(Tick if yes)' %}&nbsp;</span>
                                                </legend>

                                                {% if form.errors.optionalFields %}
                                                    <span class="help-block" style="color:#b94a48">
                                                        <small>{{ form.errors.optionalFields|first }}</small>
                                                        <br/>
                                                    </span>
                                                {% endif %}

                                                {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.is_cunit label=_('The item is a Consumer Unit') only %}
                                                {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.is_dunit label=_('The item is a Dispatch Unit') only %}
                                                {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.is_vunit label=_('The item is a Variable Weight Product') only %}
                                                {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.is_iunit label=_('The item is an Invoice Unit') only %}
                                                {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.is_ounit label=_('The item is an Orderable Unit') only %}

                                                <br/>
                                            </fieldset>
                                            <!-- product options end -->

                                            <fieldset class='fieldset'>
                                                <legend>{% trans 'Base unit indicator' %}</legend>
                                                {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.is_bunit label=_('The item is a Base Unit') readonly=True only %}
                                            </fieldset>
                                        </div>

                                        <!-- COO -->
                                        <div class="col-md-6">
                                            {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.country_of_origin label=_('Country Of Origin') only %}
                                            {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.target_market     label=_('Target Market') only %}

                                            {% if target_markets %}
                                                <label class="control-label">Other Target Markets:</label>
                                                {% for target_market in target_markets %}
                                                    <a href="{% url "products:duplicate_product" product_id=product_id target_market=target_market.target_market.code %}"
                                                       style="color:blue; text-decoration:underline;">
                                                        {{ target_market.target_market.market }}</a>
                                                    {% if forloop.revcounter0 >= 1 %},{% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            <p style="font-style:italic; font-size:smaller; color:#F26334;">
                                                To add a new Target Market: change target market, than Clone
                                            </p>

                                            {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.language          label=_('Language') only %}

                                            <div class="row">
                                                <div class="col-xs-8">
                                                    {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.gln_of_information_provider label=_('GLN of Information provider') only %}
                                                </div>
                                                <div class="col-xs-4"
                                                     style="padding-top: 32px;padding-left: 5px">
                                                    <label><input type='checkbox' id='gln-auto-fill'/>
                                                        {% trans 'Default GLN' %}
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-xs-12">
                                                    {# render_field_with_errors4_help(form.package_type) #}
                                                    {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.package_type label=_('Package Type') only %}
                                                </div>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="row">
                                        <div class="col-md-6" style="color: red">
                                            {% trans 'Fields marked with (*) are required.' %}
                                        </div>
                                    </div>

                                </fieldset>

                                {% if pkg_level != 4 and pkg_level != 70 %}
                                    <fieldset class='fieldset' id="subproducts_fs">
                                        <legend>{% trans 'Subproducts' %}<span
                                            style="font-size: 0.6em;vertical-align: middle;"> ({% trans 'subproducts contained in this item' %})&nbsp;</span>
                                        </legend>
                                        <div class="well">
                                            <table id="subproducts_tbl" class="table table-sm" style="width:100%">
                                                <thead>
                                                <tr>
                                                    <th>{% trans 'GTIN' %}</th>
                                                    <th>{% trans 'Package level' %}</th>
                                                    <th>{% trans 'Product description' %}</th>
                                                    <th>{% trans 'Quantity' %}</th>
                                                    <th></th>
                                                </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                        <a class='btn btn-success' href="javascript:void(0)" data-toggle="modal"
                                           data-target="#ProductAddSubs" onclick="">{% trans 'Add subproducts' %}</a>
                                    </fieldset>
                                {% endif %}
                                <!-- subproducts end  -->
                            </div>


                            <!---------- Tab Measurements ----------------------------------------------------------------------------------------->
                            <div id="measurements" class="tab-pane">

                                {% include 'products/_product_details_weights.html' %}

                                {% include 'products/_product_details_dimensions.html' %}

                                {% if product.package_level.id == 70 %}
                                    <fieldset class='fieldset' id='net_fs'>
                                        <legend>{% trans 'Net Content' %}</legend>
                                        <div class='row'>
                                            <div class='col-xs-6'>
                                                {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.net_content label=_('Net Content') only %}
                                            </div>
                                            <div class='col-xs-6'>
                                                {% include 'security/_macros.html' with func='render_field_with_errors4_help' field=form.net_content_uom label=_('Net Content Measurement Unit') only %}
                                            </div>
                                        </div>
                                    </fieldset>
                                {% endif %}

                            </div>


                            <!---------- Tab Advanced --------------------------------------------------------------------------------------------->
                            <div id="gepir" class="tab-pane">

                                <div class="row">
                                    <div class="col-xs-12">
                                        <fieldset class='fieldset' id="gepir_fs_2">
                                            <legend>{% trans 'Optional information' %} <span
                                                style="font-size: 0.6em;vertical-align: middle;">&nbsp;</span>
                                            </legend>
                                            <div class="row">
                                                <div class="col-xs-6">
                                                    {# render_field_with_errors4_help(form.manufacturer_gln, _label=_('Manufacturer GLN')) #}
                                                    {# render_field_with_errors4_help(form.manufacturer_name, _label=_(Manufacturer Name')) #}
                                                    {# render_field_with_errors4_help(form.brand_owner_gln, _label=_('Brand Owner GLN')) #}
                                                    {# render_field_with_errors4_help(form.brand_owner_name, _label=_('Brand Owner Name')) #}
                                                    {# render_field_with_errors4_help(form.returnable, _label=_('Returnable packaging')) #}
                                                    {# render_field_with_errors4_help(form.is_price_on_pack, _label=_('Is price on pack')) #}
                                                </div>
                                                <div class="col-xs-6">
                                                    {# render_field_with_errors4_help(form.start_availability, _label=_('Start Availability Date')) #}
                                                    {# render_field_with_errors4_help(form.end_availability, _label=_('End Availability Date')) #}
                                                    {# render_field_with_errors4_help(form.discontinued_date, _label=_('Discontinued Date')) #}
                                                </div>
                                            </div>
                                        </fieldset>
                                    </div>
                                </div>
                            </div>


                            <!---------- Tab Picture ---------------------------------------------------------------------------------------------->
                            {% if pkg_level >= 4 and pkg_level <= 70 %}
                                <div id="picture" class="tab-pane">
                                    <div class="row">
                                        <div class="col-xs-12">
                                            {% include 'products/_product_details_image.html' %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}


                            <!---------- Tab Symbols ---------------------------------------------------------------------------------------------->
                            <div id="barcodes" class="tab-pane">
                                {% if agreed %}

                                    {% if pkg_level >= 4 and pkg_level <= 70 %}

                                        <div class="row">
                                            <div class="col-xs-12" id="ean13">
                                            </div>

                                            <div class="col-xs-12" id="upca">
                                            </div>
                                        </div>

                                    {% else %}

                                        {% if pkg_level == 30 %}
                                            <div class="row">
                                                <div class="col-xs-12" id="ean128">
                                                    <div class="panel panel-default">
                                                        <br/>
                                                        <p>
                                                            {% trans 'Barcode images of pallets are not yet available.' %}
                                                        </p>
                                                        <br/>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="row">
                                                <div class="col-xs-12" id="itf14">
                                                    <div class="panel panel-default">

                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}

                                    {% endif %}

                                {% else %}
                                    <div class="row">
                                        <div class="col-xs-12">
                                            <h4>{% trans 'Agreement needed' %}</h4>

                                            <p>{% trans 'You must agree to our' %}
                                                <a href="



                                                    {# url 'static_views.terms' #}">{% trans 'Terms and Conditions' %}</a>
                                                {% trans 'in order to be able to download barcode images.' %}</p>

                                            <p>{% trans 'You can set your agreement at your' %}
                                                <a href="{% url 'users:profile' %}">{% trans 'Dashboard' %}</a></p>
                                            <br/>
                                        </div>
                                    </div>
                                    </div>
                                {% endif %}
                        </div>


                        <!---------- Tab Summary ---------------------------------------------------------------------------------------------->
                        <div id="summary" class="tab-pane"></div>


                        <!---------- Tab GS1 Cloud -------------------------------------------------------------------------------------------->
                        {% if product_package_level_id == 70 %}
                            {% include 'products/_product_cloud.html' %}
                        {% endif %}

                    </div>
                    <hr>
            </div>
            </form>

            <div class="row">
                <div class="col-xs-12">
                    {% if prefix.is_special != 'READ-ONLY' %}
                        <a class='btn btn-danger' href="javascript:productDeleteBtn()">{% trans 'Delete' %}</a>
                        {% if product_package_level_id == 70 %}
                            <a class='btn btn-default'
                               href="javascript:productClone()">{% trans 'Clone' %}</a>
                        {% endif %}
                        {% if current_user.enable_leading %}
                            <a class="btn btn-default" href="javascript:void(0)" data-toggle="modal"
                               data-target="#MakePackModal" onclick="getAvailableGtins()">{% trans 'Make a Pack' %}</a>
                        {% endif %}
                    {% endif %}

                    <a class='btn btn-primary pull-right' href="javascript:void(0)"
                       onclick="return submitForm()">{% trans 'Update' %}</a>
                </div>
            </div>
            </div>
        {% endblock page_content %}
    </div>

    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="ProductAddSubs"
         aria-hidden="true" id="ProductAddSubs">
        <div class="modal-dialog modal-sm" style="width:1000px; z-index:2">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                            class="sr-only">{% trans 'Close' %}</span></button>
                        <h4 class="modal-title" id="ProductDeleteTitle">{% trans 'Add subproducts' %}</h4>
                    </div>
                    <div class="modal-body">
                        <fieldset class='fieldset' id="av_subproducts_fs">
                            <legend>{% trans 'Available subproducts' %}</legend>
                            <div class="well">
                                <table id="av_subproducts_tbl" class="table table-sm" style="width:100%">
                                    <thead>
                                    <tr>
                                        <th>{% trans 'GTIN' %}</th>
                                        <th>{% trans 'Package level' %}</th>
                                        <th>{% trans 'Product description' %}</th>
                                        <th/>
                                    </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="ProductDeleteModal"
         aria-hidden="true" id="ProductDeleteModal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                            class="sr-only">{% trans 'Close' %}</span></button>
                        <h4 class="modal-title" id="ProductDeleteTitle">{% trans 'Product delete confirmation' %}</h4>
                    </div>
                    <div class="modal-body">
                        <p>{% blocktrans %}
                            You are about to delete one of your products. Because this action will probably create a gap
                            in your serial numbers you must choose what to do.
                        {% endblocktrans %}</p>
                        <ul class="list-unstyled">
                            <li>{% trans "Delete product and set prefix's starting GTIN to deleted product's GTIN" %}</li>
                            <li><b>{% trans 'or' %}</b></li>
                            <li>{% trans "Delete product and don't change the starting GTIN of this prefix" %}</li>
                        </ul>
                        <p>{% trans 'Keep in mind that only products that are not part of a container can be deleted.' %}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary"
                                data-dismiss="modal">{% trans "Don't delete product" %}</button>
                        <a href="{% url 'products:delete_product' product_id=product_id %}?set=1"
                           class="btn btn-warning">{% trans 'Delete and set' %}</a>
                        <a href="{# url_for('products.delete_product', product_id=product_id) #}"
                           class="btn btn-warning">{% trans 'Delete only' %}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="TargetMarketDeleteModal"
         aria-hidden="true" id="TargetMarketDeleteModal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                            class="sr-only">{% trans 'Close' %}</span></button>
                        <h4 class="modal-title"
                            id="TargetMarketDeleteTitle">{% trans 'Target Market delete confirmation' %}</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            {% trans 'You are about to delete' %}
                            <span id="TargetMarketDeleteTargetMarket"
                                  style="color:blue; text-decoration:underline;"></span>
                            {% trans 'Target Market of your product' %}
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary"
                                data-dismiss="modal">{% trans "Don't delete Target Market" %}</button>
                        <a href="{% url 'products:delete_target_market' product_id=product_id %}"
                           class="btn btn-warning">{% trans 'Delete Target Market' %}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="SubProductDeleteModal"
         aria-hidden="true" id="SubProductDeleteModal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                            class="sr-only">{% trans 'Close' %}</span></button>
                        <h4 class="modal-title"
                            id="SubProductDeleteTitle">{% trans 'Sub-product delete confirmation' %}</h4>
                    </div>
                    <div class="modal-body">
                        <p>{% blocktrans %}
                            You are about to delete one of sub-products. Subproduct would be kept in the database,
                            just the link between parent and child products would be removed.
                        {% endblocktrans %}</p>
                    </div>
                    <div class="modal-footer">
                        <button id="sub_product_delete" type="button" class="btn btn-primary" data-dismiss="modal">
                            {% trans 'Delete' %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="MakePackModal"
         aria-hidden="true" id="MakePackModal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span
                        aria-hidden="true">&times;</span><span
                        class="sr-only">{% trans 'Close' %}</span></button>
                    <h4 class="modal-title"
                        style="padding: 2px 42px;text-align: center;font-size: 1.8em;font-weight: 300;">
                        <div>{% trans 'Make a pack of trade items using' %}</div>
                        <div>{{ gtin0 }} {# render_gtin13(gtin13, prefix.prefix|length, kind) #}
                            {% trans 'as a base' %}
                        </div>
                    </h4>
                </div>
                <div class="modal-body">
                    <form method="get" action="{{ '/products/add/case/details' }}" enctype="multipart/form-data"
                          id="make_pack_form">
                        <input type="hidden" id="hidden_product_id" value="{{ product_id }}"/>
                        <div class='row'>
                            <div class="pull-left col-xs-9">
                                1) {% trans 'Choose one from the available GTINs' %}:
                            </div>
                        </div>
                        <table class="table table-striped table-condensed table-borderless" id="gtin-radios">

                        </table>

                        <hr/>
                        <div class='row'>
                            <div class="pull-left col-xs-6">
                                2) {% trans 'Indicate hierarchy level' %}:
                            </div>
                            <div class="pull-right col-xs-6">
                                <select class="form-control" id="pack_selection">
                                    <option value="60"
                                            selected> {% trans 'Pack or inner pack e.g. six pack of beer bottles' %}
                                    </option>
                                    <option
                                        value="50"> {% trans 'Outer Case e.g. case of beer (bottles or packs)' %}</option>
                                    <option value="30"> {% trans 'Pallet e.g. pallet of cases of beer' %}</option>
                                </select>
                            </div>
                        </div>
                    </form>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Cancel' %}</button>
                        <a href="javascript:void(0);" onclick="return submitMakePack();"
                           class="btn btn-primary">{% trans 'Create' %}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock site_content %}

{% block base_scripts %}
    <script src="{% static 'site/js/moment.min.js' %}"></script>
    <script src="{% static 'site/js/bootstrap-datetimepicker.min.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/select/1.2.4/js/dataTables.select.min.js"></script>
    <script type="text/javascript" charset="utf8"
            src="//cdn.datatables.net/buttons/1.5.0/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" charset="utf8"
            src="//cdn.datatables.net/buttons/1.5.0/js/buttons.flash.min.js"></script>
    <script type="text/javascript" charset="utf8"
            src="//cdn.datatables.net/buttons/1.5.0/js/buttons.html5.min.js"></script>
    <script type="text/javascript" charset="utf8"
            src="//cdn.datatables.net/buttons/1.5.0/js/buttons.print.min.js"></script>
    <script type='text/javascript' src="{% static 'site/Editor-1.7.0/js/dataTables.editor.js' %}"></script>

    <!----------- Basic page javascript ----------------------------------------------------------------------------------->
    <script type="text/javascript">
        function isNormalInteger(str) {
            var n = Math.floor(Number(str));
            return String(n) === str && n > 0;
        }

        $(document).ready(function () {

            // ------  Subproducts table (subproducts for product)
            var editor = new $.fn.dataTable.Editor({
                ajax: {
                    url: '/products/ajax/' + {{ product.id }} +'/subproduct_edit',
                    data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
                },
                table: "#subproducts_tbl",
                fields: [
                    {
                        label: "GTIN:",
                        name: "gtin",
                        type: "readonly"
                    }, {
                        label: "Description:",
                        name: "description",
                        type: "readonly"
                    }, {
                        label: "Quantity:",
                        name: "quantity"
                    }
                ]
            });

            subproductsTable = $('#subproducts_tbl').DataTable({
                ordering: false,
                searching: false,
                paging: false,
                ajax: {url: '/products/ajax/{{ product.id }}/subproducts_list', dataSrc: 'data'},
                columns: [
                    {data: 'gtin'},
                    {data: 'package_level'},
                    {data: 'description'},
                    {data: 'quantity'},
                    {
                        data: null,
                        className: "center",
                        defaultContent: '<a href="" class="editor_remove"><i\n' +
                        ' class=\'glyphicon glyphicon-remove\'\n' +
                        ' style=\'color:red;padding-right:2px;\'></i></a>'
                    }
                ],
                language: {
                    "emptyTable": "This product has no associated subproducts. <br/>" +
                    "They can be added using 'Add subproducts' button below."
                },
                columnDefs: [
                    {width: '25%', targets: 0}
                ],
                fixedColumns: true
            });

            // remove subproduct
            $('#subproducts_tbl').on('click', 'a.editor_remove', function (e) {
                e.preventDefault();
                editor.remove($(this).closest('tr'), {
                    title: 'Remove subproduct',
                    message: 'Are you sure you wish to remove this subproduct?',
                    buttons: 'Remove'
                });
            });

            // force table reload
            editor.on('submitSuccess', function (e, o, action) {
                subproductsTable.ajax.reload();
            });

            $('#subproducts_tbl').on('click', 'tbody td:nth-child(4)', function (e) {
                editor.inline(this);
            });

            editor.on('preSubmit', function (e, o, action) {
                if (action !== 'remove') {
                    var quantity = this.field('quantity');

                    if (!quantity.isMultiValue()) {
                        if (!quantity.val()) {
                            quantity.error('Quantity must be given');
                        }

                        if (!isNormalInteger(quantity.val())) {
                            quantity.error('Invalid quantity');
                        }
                    }

                    // If any error was reported, cancel the submission so it can be corrected
                    if (this.inError()) {
                        return false;
                    }
                }
            });


            // ------  Available subproducts table (add subproducts from this table)
            available_subproducts_table = $('#av_subproducts_tbl').DataTable({
                searching: true,
                paging: true,
                ajax: {url: '/products/ajax/{{ product.id }}/av_subproducts_list', dataSrc: 'data'},
                columns: [
                    {data: 'gtin', "width": "20%"},
                    {data: 'package_level', "width": "20%"},
                    {data: 'description', "width": "20%"},
                    {
                        data: null,
                        className: "center",
                        defaultContent: '<a href="" class="editor_edit">Add this</a>'
                    }
                ],
                order: [[1, 'asc']],
            });

            var av_editor = new $.fn.dataTable.Editor({
                ajax: {
                    url: '/products/ajax/' + {{ product.id }} +'/subproduct_add',
                    data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
                },
                table: '#av_subproducts_tbl',
                fields: [
                    {
                        label: 'GTIN:',
                        name: 'gtin',
                        type: 'readonly'
                    }, {
                        label: 'Description:',
                        name: 'description',
                        type: 'readonly'
                    }, {
                        label: 'Quantity:',
                        name: 'quantity',
                        attr: {
                            type: 'number'
                        }
                    }
                ]
            });

            // Create new subproduct
            $('#av_subproducts_tbl').on('click', 'a.editor_edit', function (e) {
                e.preventDefault();
                av_editor.edit($(this).closest('tr'), {
                    title: 'Add as a subproduct',
                    buttons: 'Add'
                });
                $('#ProductAddSubs').modal('toggle');
            });

            // force table reload
            av_editor.on('submitSuccess', function (e, o, action) {
                subproductsTable.ajax.reload();
            });

            av_editor.on('preSubmit', function (e, o, action) {
                if (action !== 'remove') {
                    var quantity = this.field('quantity');

                    if (!quantity.isMultiValue()) {
                        if (!quantity.val()) {
                            quantity.error('Quantity must be given');
                        }

                        if (!isNormalInteger(quantity.val())) {
                            quantity.error('Invalid quantity');
                        }
                    }

                    // If any error was reported, cancel the submission so it can be corrected
                    if (this.inError()) {
                        return false;
                    }
                }
            });
        });
    </script>

    <!----------- Measurement page javascript ----------------------------------------------------------------------------->
    <script type="text/javascript">
        $(document).ready(function () {
            if ($("#depth_uom").val() == '') {
                $("#depth").attr({'disabled': 'disabled'}).val('');
            }
            if ($("#width_uom").val() == '') {
                $("#width").attr({'disabled': 'disabled'}).val('');
            }
            if ($("#height_uom").val() == '') {
                $("#height").attr({'disabled': 'disabled'}).val('');
            }
            if ($("#gross_weight_uom").val() == '') {
                $("#gross_weight").attr({'disabled': 'disabled'}).val('');
            }
            if ($("#net_weight_uom").val() == '') {
                $("#net_weight").attr({'disabled': 'disabled'}).val('');
            }
            if ($("#net_content_uom").val() == '') {
                $("#net_content").attr({'disabled': 'disabled'}).val('');
            }

            $("#gross_weight_uom").on('change', function () {
                if ($("#gross_weight_uom").val() == '') {
                    $("#gross_weight").attr({'disabled': 'disabled'}).val('');
                } else {
                    $("#gross_weight").removeAttr('disabled');
                }
            });
            $("#net_weight_uom").on('change', function () {
                if ($("#net_weight_uom").val() == '') {
                    $("#net_weight").attr({'disabled': 'disabled'}).val('');
                } else {
                    $("#net_weight").removeAttr('disabled');
                }
            });
            $("#depth_uom").on('change', function () {
                if ($("#depth_uom").val() == '') {
                    $("#depth").attr({'disabled': 'disabled'}).val('');
                } else {
                    $("#depth").removeAttr('disabled');
                }
            });
            $("#width_uom").on('change', function () {
                if ($("#width_uom").val() == '') {
                    $("#width").attr({'disabled': 'disabled'}).val('');
                } else {
                    $("#width").removeAttr('disabled');
                }
            });
            $("#height_uom").on('change', function () {
                if ($("#height_uom").val() == '') {
                    $("#height").attr({'disabled': 'disabled'}).val('');
                } else {
                    $("#height").removeAttr('disabled');
                }
            });
            $("#net_content_uom").on('change', function () {
                if ($("#net_content_uom").val() == '') {
                    $("#net_content").attr({'disabled': 'disabled'}).val('');
                } else {
                    $("#net_content").removeAttr('disabled');
                }
            });
        })
    </script>

    <!----------- Symbols page javascript --------------------------------------------------------------------------------->
    <script type="text/javascript">
        {% if agreed %}
            <!-- BASE LVL -->
            {% if pkg_level >= 4 and pkg_level <= 70 %}
                <!-- EAN -->
                {% if barcodes.EAN13 %}
                    $("#ean13").load("{% url 'barcodes:barcodes_generate' bc_kind='EAN13' gtin=gtin %}");
                {% else %}
                    $("#ean13").load("{% url 'barcodes:barcodes_preview' bc_kind='EAN13' gtin=gtin %}");
                {% endif %}
                <!-- UPC -->
                {% if gtin13.0 == "0" %}
                    {% if barcodes.UPCA %}
                        $("#upca").load("{# url_for('barcoding.barcodes_generate', bc_kind='UPCA', gtin=gtin0+gtin13) #}");
                    {% else %}
                        $("#upca").load("{# url_for('barcoding.barcodes_preview', bc_kind='UPCA', gtin=gtin0+gtin13) #}");
                    {% endif %}
                {% endif %}
            {% endif %}

            <!-- PACK LVL -->
            {% if pkg_level >= 4 and pkg_level <= 70 %}
                {% if pkg_level == 30 %}

                {% else %}
                    <!-- ITF14 -->
                    {% if barcodes.ITF14 %}
                        $("#itf14").load("{# url_for('barcoding.barcodes_generate', bc_kind='ITF14', gtin=gtin0+gtin13) #}");
                    {% else %}
                        $("#itf14").load("{% url 'barcodes:barcodes_preview' bc_kind='ITF14' gtin=gtin %}");
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
    </script>

    <!----------- Summary tab javascript ---------------------------------------------------------------------------------->
    <script type="text/javascript">
        $("#summary").load("{% url 'products:view_product_summary' product_id=product_id %}?xhr=1")
    </script>

    <!----------- GS1 Cloud tab javascript -------------------------------------------------------------------------------->
    <script type="text/javascript">
        //cloud status table
        $('#cloud_log').DataTable({
            searching: false,
            ordering: false,
            ajax: {url: '/log_table/{{ gtin }}', dataSrc: 'data'},
            columns: [
                {data: 'rc'},
                {data: 'time'}
            ]
        });
    </script>

    <!----------- Form javascript ----------------------------------------------------------------------------------------->
    <script type="text/javascript">
        function pad(str, max) {
            str = str.toString();
            return str.length < max ? pad("0" + str, max) : str;
        }

        function submitForm() {
            var gtin0 = ($("#gtin0").val() != undefined) ? $("#gtin0").val() : '0'; //package level indicator
            $("#gtin").val(gtin0 + pad($("#gtin13").text().replace(/\s+/g, ''), 13)); // complete gtin14
            $('#detailsform').submit();
            return false;
        }

        function productClone() {
            url = '/products/{{ product_id }}/duplicate/' + target_market.value + '/';
            console.log(url);
            document.location.href = url;
        }

        function productDeleteBtn() {
            {% if target_markets|length <= 0 %}
                $('#ProductDeleteModal').modal('show');
            {% else %}
                $('#TargetMarketDeleteTargetMarket').text('{{ product.target_market.market }}')
                $('#TargetMarketDeleteModal').modal('show');
            {% endif %}
            console.log('productDeleteBtn()')
        }

        $(window).ready(function () {
            $('#product-nav a[href="#{{ active_tab }}"]').tab('show');
        })
    </script>

    <script type='text/template'>

        var csrf = '{{ form.csrf_token.current_token }}';

        $.ajaxSetup({
        headers: {
        'CSRFToken': csrf
        }
        });

        $(function () {
        $('a.remove_subproduct').on('click', function (e) {
        e.preventDefault();
        var $this = $(this);
        var id = $this.data('id');
        $.get('/messages/delete/' + id, {}, function (response) {
        $this.parent().parent().parent()
        .fadeOut(300, function () {
        $(this).remove();
        });
        });
        });
        });

        if (!String.prototype.format) {
        String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
        return typeof args[number] != 'undefined'
        ? args[number]
        : match
        ;
        });
        };
        }

        function getAvailableGtins() {
        var gtin0 = ($("#gtin0").val() != undefined) ? $("#gtin0").val() : '0';
        var gtin = gtin0 + pad($("#gtin13").text().replace(/\s+/g, ''), 13);
        $.ajax({
        url: '/barcodes/ajax/get_available_gtins/',
        dataType: 'json',
        data: {
        gtin: gtin
        },
        success: function (r) {
        var gtins = r.gtins_allocated;
        var elem = "<input name='gtins' type='radio' value='{0}' id='{1}' {2} {4}> &nbsp;&nbsp;" +
        "<label for='{1}' class='{2}'>{3}</label>";
        var render_gtin = "<span style='font-weight:300;'>{0}&nbsp;</span>{1}&nbsp;" +
        "<span style='color:#F26334;font-weight:300;'>{2}&nbsp;</span>" +
        "<span id='cd' style='font-weight:300;'>{3}</span>";
        var content = "
        <tbody>";
        // needed to know if there is at least one available GTIN and to automatically preselect the first available one
        var at_least_one = false;
        for (var idx = 0; idx < gtins.length; idx++) {
        var gtin = gtins[idx],
        id = 'gtin-' + idx,
        disabled = gtin[1] ? 'disabled' : '',
        checked = '',
        curr_gtin = render_gtin.format(gtin[0].substring(0, 1), gtin[0].substring(1, 9), gtin[0].substring(9, 13),
        gtin[0].substring(13, 14));
        if (!at_least_one && !gtin[1]) {
        at_least_one = true;
        checked = 'checked';
        }
        var curr_elem = elem.format(gtin[0], id, disabled, curr_gtin, checked);
        if (idx % 2 == 0) {
        content += '
        <tr>
            <td>' + curr_elem + '</td>
            ';
            } else {
            content += '
            <td>' + curr_elem + '</td>
        </tr>
        ';
        }
        }
        content += '
        </tbody>';
        $('#gtin-radios').html(content);
        },
        error: function (jqXHR, textStatus, errorThrown) {
        console.log('Error: ' + jqXHR.toString());
        }
        });
        }

        function submitMakePack() {
        var selected_gtin = $('input[name="gtins"]:checked').val();
        var package_level = $('#pack_selection').val();
        var product_id = +$('#hidden_product_id').val();
        //console.log(selected_gtin);
        //console.log(package_level);
        //console.log(product_id);
        $.ajax({
        url: '/update-new-product',
        type: 'post',
        dataType: 'json',
        data: {
        count: 3,

        key1: 'package_level',
        value1: package_level,

        key2: 'gtin',
        value2: selected_gtin,

        key3: 'sub_products',
        value3: product_id

        },
        success: function (r) {
        //console.log(r);
        $('#make_pack_form').submit();
        },
        error: function (jqXHR, textStatus, errorThrown) {
        console.log('Error: ' + jqXHR.toString());
        }
        });
        }

        function auto_fill() {
        if ($('#auto-fill').is(':checked')) {
        var desc = $('#brand').val() + ' '
        + $('#sub_brand').val() + ' '
        + $('#functional_name').val() + ' '
        + $('#variant').val();
        if ($("#net_content").length > 0) {
        desc = desc + ' '
        + $('#net_content').val() + ' '
        + $('#net_content_uom :selected').text() + ' ';
        }
        $('#description').val(desc);
        }
        }

        function gln_auto_fill() {
        var default_gln = "{{ product.get_leading }}";
        if ($('#gln-auto-fill').is(':checked')) {
        $('#gln_of_information_provider').val(default_gln);
        $('#gln_of_information_provider').attr('readonly', 'readonly');
        } else {
        $("#gln_of_information_provider").prop('readonly', false);
        }
        }

        function init_gln() {
        var default_gln = "{{ product.get_leading }}";
        if ($('#gln_of_information_provider').val() == default_gln) {
        $('#gln_of_information_provider').attr('readonly', 'readonly');
        $("#gln-auto-fill").attr("checked", true);
        } else {
        $("#gln_of_information_provider").prop('readonly', false);
        $("#gln-auto-fill").attr("checked", false);
        }
        }

        function GTINCheckDigit(s) {
        var result = 0;
        //console.log(s);
        for (counter = s.length - 1; counter >= 0; counter--) {
        result = result + parseInt(s.charAt(counter)) * Math.pow(3, ((counter + 1) % 2));
        }
        return (10 - (result % 10)) % 10;
        }

        function checkdigit() {
        var checkdigit;
        checkdigit = GTINCheckDigit($('#gtin0').val() + pad($("#gtin13").text().replace(/\s+/g, ''), 13).substring(0, 12));
        return checkdigit;
        }

        function Set() {
        this.content = {};
        }

        function DeleteRecordModal(id) {
        $("#SubProductDeleteModal").modal("show");
        $("#SubProductDeleteModal").attr("data-id", id);
        }

        Set.prototype.add = function (val) {
        this.content[val] = true;
        };
        Set.prototype.remove = function (val) {
        delete this.content[val];
        };
        Set.prototype.contains = function (val) {
        return (val in this.content);
        };
        Set.prototype.asArray = function () {
        var res = [];
        for (var val in this.content) res.push(val);
        return res;
        };
        var errorTabSet = new Set();


        $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();
        $('#brand, #sub_brand, #functional_name, #variant, #auto-fill').change(function (e) {
        auto_fill()
        });
        $('#gln-auto-fill').change(function (e) {
        gln_auto_fill();
        });
        $("#gtin0").on('change', function () {
        $("#cd").text(checkdigit());
        });
        $('#gtin').attr('readonly', 'readonly');
        $('#brand, #sub_brand, #functional_name, #variant, #net_content, #net_content_uom').change(function (e) {
        auto_fill()
        });

        {% include 'products/packaging_type_selector.js' %}

        var datetimepickerConfig = {
        format: "YYYY-MM-DD HH:mm:ss",
        showClear: true,
        showClose: true
        }
        $('#start_availability').datetimepicker(datetimepickerConfig);
        $('#end_availability').datetimepicker(datetimepickerConfig);
        $('#discontinued_date').datetimepicker(datetimepickerConfig);

        // set initial gln state
        init_gln();

        {% if not current_user.advanced_tab %}
            $("#is_bunit").attr({'disabled': 'disabled'}).val('');
        {% endif %}

        $(function () {
        $('fieldset.collapsible > legend').append(' (<span style="font-family: monospace;">+</span>)');
        $('fieldset.collapsible > legend').click(function () {
        var $divs = $(this).siblings();
        $divs.toggle();

        $(this).find('span').text(function () {
        return ($divs.is(':visible')) ? '-' : '+';
        });
        });
        });

        });

        $(window).ready(function () {
        $('#product-nav a[href="#{{ active_tab }}"]').tab('show');

        $(".has-error").each(function () {
        $(this).parents(".tab-pane").each(function () {
        errorTabSet.add($(this).attr("id"));
        })
        });
        errorTabSet.asArray().forEach(function (el, index) {
        $("#product-nav").find("a[href='#" + el + "']").each(function () {
        $(this).html($(this).html() + " (!)");
        if (index == 0) {
        $(this).click();
        }
        })
        })

        })
    </script>
{% endblock %}

{% block base_css %}
    <link href="{% static 'site/css/bootstrap-datetimepicker.min.css' %}?v=201610"
          rel="stylesheet"
          media="screen">
    <link rel="stylesheet" href="{% static 'site/css/add_product.css' %}"/>
    <style>
        .fieldset > legend {
            border: none;
            width: auto;
            margin-bottom: auto;
        }

        .img-align > div {
            display: inline-table;
        }

        .img-align > div > a {
            display: block;
        }

        fieldset.collapsible {
            border: 1px solid #D5D8D8;
        }

        fieldset.collapsible > legend {
            padding: 0 10px;
        }

        fieldset.collapsible > div {
            display: none;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.16/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/select/1.2.4/css/select.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'site/Editor-1.7.0/css/editor.dataTables.css' %}">

{% endblock %}
